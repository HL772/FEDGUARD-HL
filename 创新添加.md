````markdown
# 创新添加.md（给 Module 的实现说明）

> 本文用于在现有 FedGuard 单机多进程联邦学习系统上**新增创新点**，要求做到：可配置开关、可对比实验、可量化指标、可在 Dashboard 展示。  
> 现有系统已具备：FedAvg/FedProx、客户端侧 DP（裁剪+高斯噪声+ε统计）、Pairwise Masking 安全聚合、Dirichlet 非IID、采样+deadline、Top-K+量化+误差反馈、恶意检测、监控 Dashboard 等能力。 :contentReference[oaicite:0]{index=0}  
> 课设要求覆盖项：联邦框架/DP/安全聚合/非IID/通信优化/恶意检测/模型压缩/性能监控。创新点需要在这些能力之上“做深做强”。 :contentReference[oaicite:1]{index=1}

---

## 0. 基线工程约束（必须遵守）
- **不破坏现有目录与职责划分**：主要改动点围绕 `server/orchestrator.py`、`client/privacy/dp.py`、`server/aggregation/*`、`server/metrics/*`、`server/web/dashboard.*`。 :contentReference[oaicite:2]{index=2}
- **配置驱动**：所有创新点必须可通过 `experiments/configs/default.yaml` 开关启停，并能复用现有 dp/security/train/compression 配置段。 :contentReference[oaicite:3]{index=3}
- **指标闭环**：新增算法必须产出可记录 metrics.jsonl + Dashboard 可视化（曲线/分布/告警日志）。
- **对比实验**：至少提供 2 组对照（baseline vs innovation），并固定主要变量（轮次、K、alpha、ε等）。

---

## 1. 创新点 A：RDP 隐私会计 + 自适应噪声/自适应裁剪（Privacy Accounting + Adaptive DP）

### A1. 目标
把当前“DP + ε统计”升级为**更严格、可解释**的隐私会计与策略：
- 采用 **RDP Accountant（或 Moments Accountant）** 输出 ε(t) 曲线；
- 在同一 `target_epsilon` 约束下，做 **自适应噪声调度**（前期噪声大/后期噪声小或相反，取决于策略）；
- 基于每轮 update_norm 分布做 **自适应裁剪阈值 clip_norm_t**，提升效用。

### A2. 设计与数据流
- Server 每轮计算（或预先规划）`noise_multiplier_t` 与 `clip_norm_t`，下发给当轮客户端；
- Client 训练结束前：按下发参数进行裁剪与加噪；
- Server 每轮更新 accountant：累计 ε(t)，写入 metrics，并推送 Dashboard。

### A3. 需要新增/修改的代码位置
- 新增：`server/privacy/accountant.py`
  - `update(q, noise_multiplier, steps=1)` → 更新 RDP 订单与累计 ε
  - `get_epsilon(delta)` → 输出当前 ε
- 修改：`server/orchestrator.py`
  - 在“选择客户端/发任务”时附带本轮 `dp_params`（clip_norm_t, noise_multiplier_t, delta）
  - 聚合后调用 accountant 更新 ε(t)
- 修改：`client/privacy/dp.py`
  - 支持优先使用 server 下发 dp_params 覆盖默认 YAML
- 修改：`server/metrics/schema.py` + `server/metrics/store.py`
  - 新增字段：`epsilon`, `noise_multiplier`, `clip_norm`, `clip_rate` 等
- 修改：Dashboard（`server/web/dashboard.js`）
  - 新增 ε(t) 曲线、σ_t 曲线、clip_rate 曲线（或 update_norm 分位数趋势）

### A4. 配置建议（新增字段）
```yaml
dp:
  enabled: true
  mode: "adaptive_rdp"          # off | static | adaptive_rdp
  accountant: "rdp"
  delta: 1e-5
  target_epsilon: 8.0
  schedule:
    type: "cosine_decay"        # linear | exp | cosine_decay
    sigma_end_ratio: 0.5
  adaptive_clip:
    enabled: true
    percentile: 0.9
    ema: 0.2
````

### A5. 验收与对比实验

* 对比 1：`static DP (固定σ)` vs `adaptive_rdp (同 target_epsilon)`
* 输出：最终 Accuracy、收敛轮次、ε(t) 曲线、σ_t 曲线、clip_rate 曲线
* 要求：innovation 在同 ε_total 下准确率不低于 baseline（或收敛更快），并且 ε 计算可复现。

---

## 3. 创新点 C：个性化联邦学习 FedPer（Shared Backbone + Private Head）+ 公平性指标

### C1. 目标

在 Dirichlet 非IID 设置下 
提升“客户端本地效果”并衡量公平性：

* 共享 backbone（聚合）
* head 仅本地更新，不上传

### C2. 需要新增/修改的代码位置

* 修改：`client/train/local_trainer.py`

  * 模型拆分：`backbone`, `head`
  * 回传更新时只回传 backbone 的参数差分
* 修改：`server/aggregation/fedavg.py`

  * 仅聚合 backbone 参数 keys
* 指标新增（强烈建议做）：

  * `client_personal_acc`（每个客户端在自己测试集的 acc）
  * 公平性：`std(client_acc)`, `min(client_acc)`, `jain_index`

### C3. 配置建议

```yaml
train:
  algo: "fedper"       # fedavg | fedprox | fedper
model:
  split:
    backbone_keys: ["features.*"]   # 依据你的模型命名调整
    head_keys: ["classifier.*"]
```

### C4. 验收与对比实验

* 对比：FedAvg vs FedPer
* 变量：Dirichlet alpha（越小越非IID，越能体现个性化收益）
* 输出：global acc 曲线、personal acc 分布（箱线图/柱状）、公平性指标曲线

---

## 4. 创新点 D：动态客户端采样（信誉/贡献度驱动）+ 公平约束

### D1. 目标

在现有 “每轮采样 K 客户端 + deadline” 的框架上 
实现**智能调度**：

* 更快、更稳、更抗异常
* 兼顾公平：避免某些客户端长期不被选中

### D2. 设计

为每个客户端维护 score（EMA）：

* utility：loss 改善或与全局方向相似度
* reliability：是否按时完成/超时率
* suspicion：异常分（复用现有 loss/update_norm 检测）
  采样策略：
* softmax(score) + ε-greedy 探索
* 公平约束：最近 W 轮至少被选中 1 次

### D3. 需要新增/修改的代码位置

* 修改：`server/client_manager.py`

  * 增加 client 画像：`score`, `timeout_cnt`, `selected_cnt`, `last_selected_round`
* 修改：`server/orchestrator.py`

  * `select_clients()` 接入采样策略
* 指标新增：

  * `selection_histogram`, `timeout_rate`, `score_rank`

### D4. 验收与对比实验

* 对比：random sampling vs reputation sampling
* 输出：收敛速度、超时轮次占比、被选中次数分布（公平性）

---

## 5. 创新点 E：更强恶意/后门防御（攻击模拟 + 相似度检测 + Krum/Bulyan）

### E1. 目标

你已具备恶意检测与 robust 聚合基线 
把“安全闭环”做完整：**攻击 → 检测 → 防御 → 量化评估**。

### E2. 需要做的最小闭环

* 攻击模拟（客户端发送更新前 hook）：

  * sign-flip / scale / label-flip（至少 1~2 种）
* 检测增强：

  * 计算更新向量与均值方向的 cosine similarity
  * anomaly score + 可视化（热图/排名）
* 聚合增强：

  * 新增 `krum`（或 `bulyan`）到 `server/aggregation/robust.py`

### E3. 指标与验收

* 检测：precision/recall（因为你知道谁是恶意客户端）
* 防御：在攻击比例 p 下，global acc 降幅
* Dashboard：相似度热图（或 TopN 异常客户端列表 + 原因）

---

## 6. 推荐落地组合（按性价比排序）

* **组合 A（隐私最直观）**：A（RDP+自适应DP）
* **组合 B（非IID最直观）**：C（FedPer） + D（动态采样）
* **组合 C（安全最完整）**：E（攻击闭环 + Krum）

> 建议至少实现 2 个创新点，并完成 2 组对比实验与 Dashboard 展示。

---

## 7. 最低交付清单（Definition of Done）

1. default.yaml 有开关；关闭时不影响现有流程（回归通过）。 
2. metrics.jsonl 记录新增字段；Dashboard 能显示至少 2 个新增图。 
3. 提供 `experiments/scripts/*` 对比运行命令（两套配置即可）。 
4. 至少新增/更新 1~2 个 tests（例如：accountant 单测、krum 输出维度验证）。 
